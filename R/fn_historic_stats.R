#' Historic Stats Table
#'
#' @description Create a historic stats dataframe. NOTE: the inputs have to be of specific formats (mostly those generated by other functions as part of this package). If data has been saved in al_tablesernative formats, it is likely simpler to create the historic stats table manually.
#'
#' @param exam_vars A list of contants. At least the following must be defined as list elements:
#' exam
#' exam_type
#' n_stages
#' academic_year
#' cohort
#' stages
#' n_items_incl
#' items_excl_comma_sep
#' test_angoff_corr_val
#' historic_stats_comment
#' @param l_tables A list of tables (dataframes). At least the following must be defined as list elements:
#' responseSummary
#' testDetails
#' reliability
#' gradeBoundaries
#'
#' @return Returns a formatted dataframe of historic stats
#' @export
#'
#' @examples historic_stats <- fn_historic_stats(exam_vars = cnst, l_tables = tab)
#'
################################################################################
#'
fn_historic_stats <- function(exam_vars = NULL,
                              l_tables = NULL) {
  if (is.null(exam_vars) |
      is.null(l_tables)) {
    stop("One of the required variables for this function has not been specified.")
  } else{
    if (exam_vars$exam_type %in% c("AMK")) {
      # For AMK, the reliability table must be reconstructed from the Stages A and Stages B tables
      l_tables$reliability <-
        cbind(l_tables$reliabilityStagesA, l_tables$reliabilityStagesB)
      # Need to manually set the Angoff Corr. to blank for AMK
      exam_vars$test_angoff_corr_val <- ""
    }

    historic_stats <- tibble(
      Test = rep(exam_vars$exam, exam_vars$n_stages),
      AcYear = rep(exam_vars$academic_year, exam_vars$n_stages),
      Cohort = exam_vars$cohort,
      Stage = exam_vars$stages,
      Nstudents = as.numeric(l_tables$gradeDistribution["All", ]),
      Nitems = rep(exam_vars$n_items_incl, exam_vars$n_stages),
      ItemsExc = rep(exam_vars$items_excl_comma_sep, exam_vars$n_stages),
      Correct = as.numeric(l_tables$responseSummary["Percentage Correct", ]),
      Incorrect = as.numeric(l_tables$responseSummary["Percentage Incorrect", ]),
      DontKnow = as.numeric(l_tables$responseSummary["Percentage Don't Know", ]),
      Mean = as.numeric(l_tables$testDetails["Mean Score (%)", ]),
      SD = as.numeric(l_tables$testDetails["Std. Dev", ]),
      Min = as.numeric(l_tables$testDetails["Min Score (%)", ]),
      Max = as.numeric(l_tables$testDetails["Max Score (%)", ]),
      Alpha = as.numeric(l_tables$reliability["Cronbach's Alpha", ]),
      RelativeSEM = as.numeric(l_tables$reliability["Relative SEM", ]),
      Phi = as.numeric(l_tables$reliability["Phi Coefficient", ]),
      AbsoluteSEM = as.numeric(l_tables$reliability["Absolute SEM", ]),
      Borderline = as.numeric(l_tables$gradeBoundaries["Borderline", ]),
      Satisfactory = as.numeric(l_tables$gradeBoundaries["Satisfactory", ]),
      Excellent = as.numeric(l_tables$gradeBoundaries["Excellent", ]),
      AngoffCorrel = c(rep("", exam_vars$n_stages - 1), exam_vars$test_angoff_corr_val),
      Comments = exam_vars$historic_stats_comment
    )

    return(historic_stats)
  }
}
